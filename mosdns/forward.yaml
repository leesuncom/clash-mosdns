plugins:
  # ===================== ECS 插件（优化境外解析）=====================
  - tag: ecs_jp
    type: ecs_handler
    args:
      forward: false
      preset: 13.78.0.0
      send: false
      mask4: 17

  - tag: ecs_sjc
    type: ecs_handler
    args:
      forward: false
      preset: 151.101.48.0
      send: false
      mask4: 22

  - tag: ecs_lax
    type: ecs_handler
    args:
      forward: false
      preset: 151.101.196.0
      send: false
      mask4: 22

  # 3. DNSPod DNS（DoH + DoT 协议，阿里云备用）
  - tag: forward_dnspod
    type: forward
    args:
      concurrent: 1
      upstreams:
        - addr: "https://doh.pub/dns-query" # 标准 DoH 格式
          dial_addr: "1.12.12.12"
        - addr: "tls://dot.pub:853" # 标准 DoT 格式（补充端口 853）
          dial_addr: "120.53.53.53"


  # 2. 阿里云 DNS（QUIC + DoH 协议，优先使用）
  - tag: forward_alidns
    type: forward
    args:
      concurrent: 1
      upstreams:
        - addr: "quic://dns.alidns.com" # 标准 DoQ/QUIC 格式
        - addr: "https://dns.alidns.com/dns-query" # 标准 DoH 格式
          dial_addr: "223.5.5.5"
          enable_http3: true # 开启 HTTP/3 支持

  # 1. 本地运营商 DNS（最后兜底，恢复原设计）
  - tag: forward_local
    type: forward
    args:
      concurrent: 1
      upstreams:
        - addr: "https://doh.pub/dns-query" # 标准 DoH 格式
          dial_addr: "1.12.12.12"
        - addr: "tls://dot.pub:853" # 标准 DoT 格式（补充端口 853）
          dial_addr: "120.53.53.53"


  # 4. 境外 DNS（Cloudflare DoT + DoH + 本地代理）
  - tag: forward_remote
    type: forward
    args:
      concurrent: 1
      upstreams:
        - addr: "tls://1.1.1.1:853" # Cloudflare DoT（补充标准端口 853）
          dial_addr: "1.1.1.1"
        - addr: "https://cloudflare-dns.com/dns-query" # Cloudflare DoH
          dial_addr: "1.0.0.1"
          enable_http3: true
        - addr: "udp://127.0.0.1:5353" # 本地代理 DNS 兜底
          enable_pipeline: true

  # ===================== 解析序列（修复语法错误）=====================
  # 国内域名解析序列
  # 国内域名解析序列
  - tag: domestic_sequence
    type: sequence
    args:
      - exec: prefer_ipv4
      - exec: $forward_alidns
      - exec: $forward_dnspod # 国内域名走dnspod
      - exec: $forward_local
      - exec: accept # 有结果直接返回

  # 境外域名 IPv4 解析序列
  - tag: remote_sequence
    type: sequence
    args:
      - exec: prefer_ipv4
      - exec: $ecs_sjc
      - exec: $forward_remote
      - exec: return

  # 境外域名 IPv6 解析序列
  - tag: remote_sequence_ipv6
    type: sequence
    args:
      - exec: prefer_ipv6
      - exec: $forward_remote
      - exec: return

  # 兜底：有解析结果直接返回
  - tag: has_resp_sequence
    type: sequence
    args:
      - matches:
          - has_resp
        exec: accept
